# Default values for PowerDNS
replicaCount: 1

image:
  repository: pschiffe/pdns-mysql
  tag: "4.9"
  pullPolicy: IfNotPresent

# PowerDNS configuration
powerdns:
  # API configuration
  api:
    enabled: true
    # API key will be sourced from secret
    secretName: powerdns-api-key
    secretKey: PDNS_API_KEY

  # Web server configuration
  webserver:
    enabled: true
    port: 8081
    address: "0.0.0.0"
    allowFrom: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

  # Database backend configuration (gmysql with auto-initialization)
  backend: "gmysql"
  mysql:
    host: "{{ .Release.Name }}-mariadb"
    port: 3306
    database: "powerdns"
    user: "powerdns"
    # Password will be auto-generated by MariaDB subchart

  # Additional PowerDNS configuration
  config:
    # Enable AXFR for VPS secondary zone
    allow-axfr-ips: "10.0.0.0/8,100.64.0.3" # Allow cluster network and VPS Tailscale IP
    disable-axfr: "no"
    # Send NOTIFY to VPS secondary when zone changes
    also-notify: "100.64.0.3" # VPS Tailscale IP
    # Example:
    # local-port: 5353
    # local-address: "0.0.0.0"

# Service configuration
service:
  # DNS service (public-facing)
  dns:
    type: LoadBalancer
    port: 53
    protocol: Both # TCP and UDP
    annotations:
      {}
      # metallb.universe.tf/address-pool: dns-pool
      # metallb.universe.tf/loadBalancerIPs: 10.0.3.3

  # API service (internal)
  api:
    type: ClusterIP
    port: 8081

# Persistence configuration
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi
  # existingClaim: ""

# External Secret Operator integration
externalSecret:
  enabled: false
  # If enabled, creates ExternalSecret for PowerDNS API key
  secretStore:
    name: vault-backend
    kind: ClusterSecretStore
  # Vault path for PowerDNS API key
  vaultPath: "kv/data/powerdns"
  # Generated secret name
  secretName: powerdns-api-key

# Resource limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Health checks
healthChecks:
  enabled: true
  livenessProbe:
    httpGet:
      path: /
      port: api
    initialDelaySeconds: 30
    periodSeconds: 10
  readinessProbe:
    httpGet:
      path: /
      port: api
    initialDelaySeconds: 5
    periodSeconds: 5

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 953
  runAsGroup: 953
  allowPrivilegeEscalation: false
  capabilities:
    add: ["NET_BIND_SERVICE"]
    drop: ["ALL"]
  seccompProfile:
    type: RuntimeDefault

# Pod security context
podSecurityContext:
  fsGroup: 953
  seccompProfile:
    type: RuntimeDefault

# Node selection
nodeSelector: {}
tolerations: []
affinity: {}

# Pod annotations
podAnnotations:
  # Skip Cilium DNS proxy - PowerDNS is an authoritative server, not a client
  # Cilium's transparent DNS proxy with 10s linger timeout breaks AXFR zone transfers
  io.cilium.proxy.denylist: "53/TCP,53/UDP"

# Service account
serviceAccount:
  create: false
  name: ""

# MariaDB subchart configuration
mariadb:
  enabled: true
  auth:
    database: powerdns
    username: powerdns
    # Passwords auto-generated by chart and stored in Kubernetes secret
  primary:
    persistence:
      enabled: true
      storageClass: "proxmox-csi-retain"
      size: 2Gi
