apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "attic.fullname" . }}-config
  labels:
    {{- include "attic.labels" . | nindent 4 }}
data:
  server.toml: |
    # Attic Server Configuration
    listen = {{ .Values.config.listen | quote }}

    [storage]
    type = {{ .Values.config.storage.type | quote }}
    {{- if eq .Values.config.storage.type "local" }}
    path = {{ .Values.config.storage.path | quote }}
    {{- end }}

    [database]
    {{- if .Values.postgresql.enabled }}
    url = "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "attic.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}"
    {{- else }}
    url = {{ .Values.config.database.url | quote }}
    {{- end }}

    [compression]
    type = {{ .Values.config.compression.type | quote }}

    [chunking]
    nar-size-threshold = {{ index .Values.config.chunking "nar-size-threshold" }}
    min-size = {{ index .Values.config.chunking "min-size" }}
    avg-size = {{ index .Values.config.chunking "avg-size" }}
    max-size = {{ index .Values.config.chunking "max-size" }}

    [garbage-collection]
    interval = {{ index .Values.config "garbage-collection" "interval" | quote }}

    # JWT token (from secret)
    [jwt.signing]
    {{- if .Values.config.jwtSecretBase64 }}
    token-hs256-secret-base64 = {{ .Values.config.jwtSecretBase64 | quote }}
    {{- else }}
    # JWT secret will be injected via secret mount
    {{- end }}
