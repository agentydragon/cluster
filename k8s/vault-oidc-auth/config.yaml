apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: vault-oidc-auth
  namespace: flux-system
spec:
  interval: 15m
  path: ./terraform/vault-oidc-auth
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system

  # No dependencies - sets up basic Vault configuration

  # Use in-cluster service account
  serviceAccountName: tf-runner
  approvePlan: "auto"

  # Configure runner to trust Vault's self-signed CA
  runnerPodTemplate:
    spec:
      volumes:
        - name: vault-ca
          secret:
            secretName: vault-internal-tls
            items:
              - key: ca.crt
                path: ca.crt
      containers:
        - name: tf-runner
          volumeMounts:
            - name: vault-ca
              mountPath: /vault/tls
              readOnly: true
          env:
            - name: VAULT_CACERT
              value: /vault/tls/ca.crt

  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix    = "vault-oidc-auth"
        namespace        = "flux-system"
      }

  # Variables for Terraform
  vars:
    - name: vault_address
      value: "https://instance.vault.svc.cluster.local:8200"
    - name: kubernetes_api_url
      value: "https://kubernetes.default.svc.cluster.local"

  # Get secrets from Kubernetes
  varsFrom:
    - kind: Secret
      name: vault-token
      varsKeys:
        - vault_token
      optional: false
    - kind: Secret
      name: vault-oauth-client-secret
      varsKeys:
        - client_secret:vault_client_secret
      optional: true
