apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: services-config
  namespace: flux-system
spec:
  interval: 15m
  path: ./terraform/gitops/services
  sourceRef:
    kind: GitRepository
    name: cluster
    namespace: flux-system

  # Depend on Authentik config being ready
  dependsOn:
    - name: authentik-config
      namespace: flux-system

  # Use in-cluster service account
  serviceAccountName: tf-runner

  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix    = "services-config"
        config_path      = "/tmp/kubeconfig"
        namespace        = "flux-system"
      }

  # Variables for Terraform
  vars:
    - name: authentik_url
      value: "https://auth.test-cluster.agentydragon.com"
    - name: authentik_external_url
      value: "https://auth.test-cluster.agentydragon.com"
    - name: harbor_url
      value: "https://registry.test-cluster.agentydragon.com"
    - name: harbor_external_url
      value: "https://registry.test-cluster.agentydragon.com"
    - name: harbor_username
      value: "admin"
    - name: gitea_url
      value: "https://git.test-cluster.agentydragon.com"
    - name: gitea_external_url
      value: "https://git.test-cluster.agentydragon.com"
    - name: matrix_external_url
      value: "https://matrix.test-cluster.agentydragon.com"
    - name: vault_address
      value: "https://vault.test-cluster.agentydragon.com"
    - name: kubeconfig_path
      value: "/tmp/kubeconfig"
