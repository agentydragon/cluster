apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: sso-secrets
  namespace: flux-system
spec:
  interval: 15m
  path: ./sso-terraform/secrets
  sourceRef:
    kind: GitRepository
    name: cluster
    namespace: flux-system
  
  # Use in-cluster service account
  serviceAccountName: tf-runner
  
  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix    = "sso-secrets"
        config_path      = "/tmp/kubeconfig"
        namespace        = "flux-system"
      }
  
  # Variables for Terraform
  vars:
    - name: vault_address
      value: "https://vault.test-cluster.agentydragon.com"
    - name: kubeconfig_path
      value: "/tmp/kubeconfig"
  
  # Write outputs to Kubernetes secret
  writeOutputsToSecret:
    name: sso-secrets-outputs
    outputs:
      - harbor_client_secret
      - gitea_client_secret  
      - matrix_client_secret
      - authentik_bootstrap_token
---
# Service account for Terraform runner
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tf-runner
  namespace: flux-system
---
# ClusterRole for Terraform runner
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tf-runner
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
---
# ClusterRoleBinding for Terraform runner
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tf-runner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tf-runner
subjects:
- kind: ServiceAccount
  name: tf-runner
  namespace: flux-system