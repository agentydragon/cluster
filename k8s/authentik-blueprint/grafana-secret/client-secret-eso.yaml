---
# ExternalSecret for complete Grafana OIDC configuration from Vault
# Terraform writes individual fields to Vault, ESO templates them into YAML
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-oidc-config
  namespace: monitoring
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: grafana-oidc-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        auth.generic_oauth.yaml: |
          enabled: {{ .enabled }}
          name: {{ .name }}
          client_id: {{ .client_id }}
          client_secret: {{ .client_secret }}
          scopes: {{ .scopes }}
          auth_url: {{ .auth_url }}
          token_url: {{ .token_url }}
          api_url: {{ .api_url }}
          role_attribute_path: {{ .role_attribute_path }}
          allow_sign_up: {{ .allow_sign_up }}
  dataFrom:
    - extract:
        key: sso/oidc-providers/grafana
