---
apiVersion: v1
kind: Namespace
metadata:
  name: metallb-system
  labels:
    # Required for pod security admission in Kubernetes 1.23+
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metallb
  namespace: metallb-system
spec:
  interval: 15m
  chart:
    spec:
      chart: metallb
      version: "0.15.2"
      sourceRef:
        kind: HelmRepository
        name: metallb
        namespace: metallb-system
  values:
    # Controller configuration
    controller:
      resources:
        limits:
          cpu: 100m
          memory: 100Mi
        requests:
          cpu: 10m
          memory: 50Mi

      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534

    # Speaker configuration (BGP/L2 announcements)
    speaker:

      resources:
        limits:
          cpu: 100m
          memory: 100Mi
        requests:
          cpu: 10m
          memory: 50Mi

      # Tolerations to run on all nodes including control planes
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"

    # RBAC
    rbac:
      create: true

    # Service account
    serviceAccount:
      create: true
      name: metallb-controller

    # Prometheus monitoring
    prometheus:
      serviceAccount: metallb-controller
      namespace: metallb-system

    # Logging
    logLevel: info