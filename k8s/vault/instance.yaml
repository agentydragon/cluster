---
apiVersion: "vault.banzaicloud.com/v1alpha1"
kind: "Vault"
metadata:
  name: "instance"
  namespace: "vault"
spec:
  size: 3 # HA cluster with 3 replicas for failover
  image: "hashicorp/vault:1.17.2"

  # Bank-Vaults automatically handles initialization and unsealing
  # TODO: IPC_LOCK should not require particularly wide privileges - investigate capability restrictions
  bankVaultsImage: "ghcr.io/bank-vaults/bank-vaults:v1.32.0"

  # Storage configuration - each replica gets its own PVC
  volumeClaimTemplates:
    - metadata:
        name: vault-raft
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: proxmox-csi-retain
        resources:
          requests:
            storage: 10Gi

  volumeMounts:
    - name: vault-raft
      mountPath: /vault/file

  # Canonical Raft HA configuration - sequential join to established leader
  # References:
  # - https://developer.hashicorp.com/vault/docs/configuration/storage/raft#retry_join-stanza
  # - https://developer.hashicorp.com/vault/tutorials/raft/raft-deployment-guide#vault-server-configuration-file
  # - https://developer.hashicorp.com/vault/docs/platform/k8s/helm/run#standalone-server-with-integrated-storage
  config:
    storage:
      raft:
        path: "/vault/file"
        retry_join:
          # All cluster members listed for automatic discovery and sequential joining
          # Bank-Vaults creates StatefulSet pods: instance-0, instance-1, instance-2
          - leader_api_addr: "http://instance-0.vault.svc.cluster.local:8200"
          - leader_api_addr: "http://instance-1.vault.svc.cluster.local:8200"
          - leader_api_addr: "http://instance-2.vault.svc.cluster.local:8200"
    listener:
      tcp:
        address: "0.0.0.0:8200"
        cluster_address: "0.0.0.0:8201"
        tls_disable: true
    # Required addresses for Raft cluster communication
    # References: https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/
    # api_addr: External address for client requests (load-balanced service)
    # cluster_addr: Pod-specific address for Raft protocol - Bank-Vaults template syntax
    api_addr: "http://instance.vault.svc.cluster.local:8200"
    cluster_addr: "http://${.Env.POD_NAME}.vault.svc.cluster.local:8201"
    ui: true

  # Automatic unsealing using Kubernetes secrets
  unsealConfig:
    options:
      # Store unseal keys and root token in Kubernetes secrets
      preFlightChecks: true
      storeRootToken: true
    kubernetes:
      secretNamespace: "vault"

  # Enable essential auth methods and secrets engines
  externalConfig:
    auth:
      - type: kubernetes
        path: kubernetes

    secrets:
      - path: kv
        type: kv
        description: "General secrets"
        options:
          version: 2

    # Note: PowerDNS API key will be generated by ExternalSecrets Operator
    # using its Password generator and stored in Vault via PushSecret

  # Service configuration
  serviceType: "NodePort"

  # Resource limits (correct Bank-Vaults schema)
  resources:
    vault:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  # Environment variables for templating - Bank-Vaults uses envsConfig (not vaultEnvsConfig)
  # References: https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/
  envsConfig:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  # Service account
  serviceAccount: vault

  # Pod anti-affinity for HA - spread replicas across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: vault
            topologyKey: kubernetes.io/hostname
