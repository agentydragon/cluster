---
apiVersion: v1
kind: Namespace
metadata:
  name: gitea
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: gitea-charts
  namespace: gitea
spec:
  interval: 24h
  url: https://dl.gitea.com/charts/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitea
  namespace: gitea
spec:
  interval: 15m
  chart:
    spec:
      chart: gitea
      version: "12.4.0"
      sourceRef:
        kind: HelmRepository
        name: gitea-charts
        namespace: gitea
  values:
    # Global configuration
    global:
      imageRegistry: ""

    # Gitea configuration
    gitea:
      admin:
        # Username and password from ESO-generated secret
        existingSecret: "gitea-admin-password"
        email: "admin@test-cluster.agentydragon.com"

      config:
        APP_NAME: "Gitea: Git with a cup of tea"
        RUN_MODE: prod

        server:
          DOMAIN: git.test-cluster.agentydragon.com
          SSH_DOMAIN: git.test-cluster.agentydragon.com
          ROOT_URL: https://git.test-cluster.agentydragon.com
          HTTP_PORT: 3000
          SSH_PORT: 2222
          DISABLE_SSH: false
          START_SSH_SERVER: true

        session:
          PROVIDER: db

        cache:
          ENABLED: true
          ADAPTER: memory

        queue:
          TYPE: level

        security:
          INSTALL_LOCK: true
          SECRET_KEY: "change-this-secret-key-in-production"

        oauth2_client:
          REGISTER_EMAIL_CONFIRM: false
          ENABLE_AUTO_REGISTRATION: true
          USERNAME: nickname
          UPDATE_AVATAR: true
          ACCOUNT_LINKING: login

    # Service configuration
    service:
      http:
        type: NodePort
        port: 3000
        nodePort: 30500
      ssh:
        type: NodePort
        port: 2222
        nodePort: 30501

    # Ingress disabled (using NodePort)
    ingress:
      enabled: false

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    # Persistence
    persistence:
      enabled: true
      size: 10Gi

    # PostgreSQL configuration with full chart auto-management
    postgresql:
      enabled: true
      global:
        postgresql:
          auth:
            username: gitea
            database: gitea
            # No password specified - let chart fully auto-generate

    # Disable PostgreSQL HA (using single instance instead)
    postgresql-ha:
      enabled: false

    # Redis (disabled)
    redis-cluster:
      enabled: false

    # Memcached (disabled)
    memcached:
      enabled: false

    # Service account
    serviceAccount:
      create: true
