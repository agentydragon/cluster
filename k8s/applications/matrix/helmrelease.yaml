---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: ananace-charts
  namespace: matrix
spec:
  interval: 24h
  url: https://ananace.gitlab.io/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: matrix-synapse
  namespace: matrix
spec:
  interval: 15m
  chart:
    spec:
      chart: matrix-synapse
      version: "3.12.12"
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: matrix
  values:
    # Synapse image configuration
    image:
      repository: matrixdotorg/synapse
      tag: v1.120.2
      pullPolicy: IfNotPresent

    # Server name - this is the domain used in Matrix user IDs (@user:test-cluster.agentydragon.com)
    serverName: test-cluster.agentydragon.com

    # Public baseurl - this is the actual URL where Synapse is accessible
    publicBaseurl: https://matrix.test-cluster.agentydragon.com

    # Resources
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 512Mi

    # Persistence for media store
    persistence:
      enabled: true
      storageClass: "proxmox-data-xfs"
      size: 20Gi
      accessMode: ReadWriteOnce

    # Synapse configuration via extraConfig
    config:
      # Enable registration (initially disabled, can be enabled later)
      enableRegistration: false

      # Report stats to matrix.org (optional)
      reportStats: false

    # Signing key from secret
    signingkey:
      job:
        enabled: false
      existingSecret: synapse-signing-key
      existingSecretKey: signing.key

    # OIDC configuration via extraConfig
    extraConfig:
      # Registration shared secret for creating users via admin API
      registration_shared_secret_path: /synapse/secrets/registration/secret

      # Macaroon secret key
      macaroon_secret_key_path: /synapse/secrets/macaroon/secret

      # OIDC provider configuration for Authentik
      oidc_providers:
        - idp_id: authentik
          idp_name: "Authentik SSO"
          discover: true
          issuer: "https://auth.test-cluster.agentydragon.com/application/o/matrix/"
          client_id: "matrix"
          client_secret_path: /synapse/secrets/oidc/client_secret
          scopes:
            - "openid"
            - "profile"
            - "email"
          user_mapping_provider:
            config:
              localpart_template: "{{ user.preferred_username }}"
              display_name_template: "{{ user.name }}"
              email_template: "{{ user.email }}"
          allow_existing_users: true
          # Enable users to log in with both OIDC and password
          enable_registration: true

    # Extra volumes for secrets
    extraVolumes:
      - name: oidc-secret
        secret:
          secretName: matrix-oauth-client-secret
      - name: registration-secret
        secret:
          secretName: synapse-registration-secret
      - name: macaroon-secret
        secret:
          secretName: synapse-macaroon-secret

    extraVolumeMounts:
      - name: oidc-secret
        mountPath: /synapse/secrets/oidc
        readOnly: true
      - name: registration-secret
        mountPath: /synapse/secrets/registration
        readOnly: true
      - name: macaroon-secret
        mountPath: /synapse/secrets/macaroon
        readOnly: true

    # Service configuration
    service:
      type: ClusterIP
      port: 8008
      federation:
        enabled: true
        port: 8448

    # Ingress configuration
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod-dns"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        # Increase body size for media uploads
        nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      # Client-to-Server API hosts
      csHosts:
        - matrix.test-cluster.agentydragon.com
      # Server-to-Server (federation) hosts
      hosts:
        - test-cluster.agentydragon.com
      # Include /_synapse admin APIs
      includeUnderscoreSynapse: true
      # Include server name in csHosts automatically
      includeServerName: false
      tls:
        - secretName: matrix-synapse-tls
          hosts:
            - matrix.test-cluster.agentydragon.com
            - test-cluster.agentydragon.com

    # PostgreSQL configuration with bundled chart
    postgresql:
      enabled: true
      auth:
        username: synapse
        database: synapse
        # PostgreSQL chart auto-generates password
      primary:
        persistence:
          enabled: true
          storageClass: "proxmox-data-xfs"
          size: 10Gi
        # Required PostgreSQL settings for Synapse
        initdb:
          scriptsConfigMap: synapse-postgres-initdb
        # PostgreSQL 16 compatible settings
        extendedConfiguration: |
          max_connections = 200
          shared_buffers = 256MB

    # Enable Redis (required by chart even for single-instance setup)
    redis:
      enabled: true
      auth:
        enabled: false
      master:
        persistence:
          enabled: false
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi

    # Synapse workers (disabled for now, can be enabled for scaling)
    workers:
      default:
        enabled: false

    # Service account
    serviceAccount:
      create: true
---
# ConfigMap for PostgreSQL initialization with proper collation
apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-postgres-initdb
  namespace: matrix
data:
  00-init.sh: |
    #!/bin/bash
    set -e
    # Ensure database has correct collation for Synapse
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
      -- Update database settings for Synapse compatibility
      ALTER DATABASE synapse SET LC_COLLATE = 'C';
      ALTER DATABASE synapse SET LC_CTYPE = 'C';
    EOSQL
