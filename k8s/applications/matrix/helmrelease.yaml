---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: ananace-charts
  namespace: matrix
spec:
  interval: 24h
  url: https://ananace.gitlab.io/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: matrix-synapse
  namespace: matrix
spec:
  interval: 15m
  chart:
    spec:
      chart: matrix-synapse
      version: "3.12.12"
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: matrix
  valuesFrom:
    - kind: Secret
      name: matrix-oauth-client-secret
      valuesKey: client_secret
      targetPath: extraSecrets.oidc_providers[0].client_secret
  values:
    # Synapse image configuration
    image:
      repository: matrixdotorg/synapse
      tag: v1.120.2
      pullPolicy: IfNotPresent

    # Server name - this is the domain used in Matrix user IDs (@user:test-cluster.agentydragon.com)
    serverName: test-cluster.agentydragon.com

    # Public baseurl - this is the actual URL where Synapse is accessible
    publicBaseurl: https://matrix.test-cluster.agentydragon.com

    # Resources
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 512Mi

    # Persistence for media store
    persistence:
      enabled: true
      storageClass: "proxmox-csi-retain"
      size: 20Gi
      accessMode: ReadWriteOnce

    # Synapse configuration via extraConfig
    config:
      # Enable registration (initially disabled, can be enabled later)
      enableRegistration: false

      # Report stats to matrix.org (optional)
      reportStats: false

      # Let the chart auto-generate these secrets
      # macaroonSecretKey and registrationSharedSecret will be generated automatically

    # Signing key - let the chart generate it
    signingkey:
      job:
        enabled: true

    # OIDC configuration via extraSecrets (sensitive values)
    extraSecrets:
      oidc_providers:
        - idp_id: authentik
          idp_name: "Authentik SSO"
          discover: true
          # TODO: Consider switching to HTTPS with custom CA trust once production certs are in place
          # Using internal cluster URL to avoid staging cert validation issues
          issuer: "http://authentik-server.authentik/application/o/matrix/"
          client_id: "matrix"
          # client_secret injected via valuesFrom from matrix-oauth-client-secret
          scopes:
            - "openid"
            - "profile"
            - "email"
          user_mapping_provider:
            config:
              localpart_template: "{{ user.preferred_username }}"
              display_name_template: "{{ user.name }}"
              email_template: "{{ user.email }}"
          allow_existing_users: true
          # Enable users to log in with both OIDC and password
          enable_registration: true

    # Service configuration
    service:
      type: ClusterIP
      port: 8008
      federation:
        enabled: true
        port: 8448

    # Ingress configuration
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        # Increase body size for media uploads
        nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      # Client-to-Server API hosts
      csHosts:
        - matrix.test-cluster.agentydragon.com
      # Server-to-Server (federation) hosts
      hosts:
        - test-cluster.agentydragon.com
      # Include /_synapse admin APIs
      includeUnderscoreSynapse: true
      # Include server name in csHosts automatically
      includeServerName: false
      tls:
        - secretName: matrix-synapse-tls
          hosts:
            - matrix.test-cluster.agentydragon.com
            - test-cluster.agentydragon.com

    # PostgreSQL configuration with bundled chart
    postgresql:
      enabled: true
      auth:
        username: synapse
        database: synapse
        # PostgreSQL chart auto-generates password
      global:
        storageClass: "proxmox-csi-retain"
      primary:
        persistence:
          enabled: true
          storageClass: "proxmox-csi-retain"
          size: 10Gi
        # PostgreSQL 16 compatible settings
        extendedConfiguration: |
          max_connections = 200
          shared_buffers = 256MB
        # Synapse requires C collation - set via initdb args
        initdb:
          args: "--locale=C"

    # Enable Redis (required by chart even for single-instance setup)
    redis:
      enabled: true
      auth:
        enabled: true
        password: "matrix-redis-password-change-me"
      master:
        persistence:
          enabled: false
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi

    # Synapse workers (disabled for now, can be enabled for scaling)
    workers:
      default:
        enabled: false

    # Service account
    serviceAccount:
      create: true
---
# ConfigMap for PostgreSQL initialization with proper collation
apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-postgres-initdb
  namespace: matrix
data:
  00-init.sh: |
    #!/bin/bash
    set -e
    # Ensure database has correct collation for Synapse
    # Note: This runs as postgres user, after database creation
    # The collation must be set during database creation instead
    echo "Database collation check script (collation should be set during CREATE DATABASE)"
