# Generate PowerDNS API key using ExternalSecrets Operator
# This uses ESO's password generator to create a random key
# Then pushes it to Vault for persistence
---
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: powerdns-api-key-generator
  namespace: dns-system
spec:
  length: 32
  digits: 10
  symbols: 0 # No symbols for simpler API key
  noUpper: false
  allowRepeat: true
---
# Push the generated password to Vault (if it doesn't exist)
apiVersion: external-secrets.io/v1beta1
kind: PushSecret
metadata:
  name: powerdns-api-key-push
  namespace: dns-system
spec:
  refreshInterval: 0 # Only push once, don't overwrite
  secretStoreRefs:
    - name: vault-backend
      kind: SecretStore
  selector:
    secret:
      name: powerdns-api-key-generated
  data:
    - match:
        secretKey: api_key
        remoteRef:
          remoteKey: kv/powerdns/api
          property: api_key
---
# Pull the secret back from Vault to create K8s secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: powerdns-api-key
  namespace: dns-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: powerdns-api-key
    creationPolicy: Owner
  data:
    - secretKey: powerdns_api_key
      remoteRef:
        key: kv/powerdns/api
        property: api_key
---
# SecretStore for Vault connection
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: dns-system
spec:
  provider:
    vault:
      server: "http://instance.vault.svc.cluster.local:8200"
      path: kv
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes
          role: default
          serviceAccountRef:
            name: default
