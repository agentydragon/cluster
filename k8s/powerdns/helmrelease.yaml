---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: powerdns
  namespace: dns-system
spec:
  interval: 15m
  chart:
    spec:
      chart: ./charts/powerdns
      sourceRef:
        kind: GitRepository
        name: powerdns-chart
        namespace: dns-system
      interval: 15m
  values:
    # Image configuration
    image:
      repository: powerdns/pdns-auth-49
      tag: "4.9.11"
      pullPolicy: IfNotPresent

    # Service configuration with MetalLB
    service:
      dns:
        type: LoadBalancer
        annotations:
          metallb.universe.tf/address-pool: dns-pool
          metallb.universe.tf/loadBalancerIPs: 10.0.3.3

    # PowerDNS configuration
    powerdns:
      api:
        enabled: true
        secretName: powerdns-api-key
        secretKey: PDNS_API_KEY
      webserver:
        enabled: true
        allowFrom: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
      backend: "gsqlite3"

    # Storage configuration
    persistence:
      enabled: true
      size: 1Gi

    # External Secret integration - use our chart's built-in ESO support
    externalSecret:
      enabled: true
      secretStore:
        name: vault-backend
        kind: ClusterSecretStore
      secretName: powerdns-api-key
