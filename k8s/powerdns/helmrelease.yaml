---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: powerdns
  namespace: dns-system
spec:
  interval: 15m
  chart:
    spec:
      chart: .
      sourceRef:
        kind: GitRepository
        name: cdwv-powerdns
        namespace: dns-system
      interval: 15m
  values:
    # PowerDNS configuration
    pdns:
      api:
        enabled: yes
        key: "PDNSSecureAPIKey2024-AutoGenerated-$(date +%s)" # Random key
      webserver:
        allowFrom: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" # Private networks only
      dnsupdate:
        enabled: no

    # Use single replica for DNS consistency
    replicaCount: 1

    # Resource limits
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

    # Service configuration - ensure we get same ports as before
    service:
      type: LoadBalancer
      annotations:
        metallb.universe.tf/address-pool: dns-pool
        metallb.universe.tf/loadBalancerIPs: 10.0.3.3

    # Disable ingress (we don't need web UI exposed)
    ingress:
      enabled: false

    # MariaDB configuration (backend database)
    mariadb:
      db:
        user: powerdns
        password: "PowerDNSDBPass2024-$(date +%s)"
        name: powerdns
      master:
        persistence:
          enabled: true
          accessModes:
            - ReadWriteOnce
          size: 2Gi # Smaller size for our needs
      metrics:
        enabled: false # Disable for now
