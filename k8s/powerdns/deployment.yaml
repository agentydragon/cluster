---
apiVersion: v1
kind: ConfigMap
metadata:
  name: powerdns-config
  namespace: dns-system
data:
  pdns.conf: |
    # PowerDNS configuration for cluster DNS
    launch=gsqlite3
    gsqlite3-database=/var/lib/powerdns/pdns.db

    # API configuration for cert-manager integration
    api=yes
    api-key=changeme-secure-api-key
    webserver=yes
    webserver-address=0.0.0.0
    webserver-port=8081
    webserver-allow-from=0.0.0.0/0

    # Security settings
    security-poll-suffix=
    disable-syslog=yes
    log-dns-details=yes
    loglevel=4

    # Performance settings
    cache-ttl=60
    negquery-cache-ttl=60
    query-cache-ttl=60

    # Zone transfer settings
    master=yes
    slave=no
---
# TODO: Replace with ExternalSecret that syncs from Vault when migrating PowerDNS API key
# Secret is generated by powerdns-secrets Terraform resource
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: powerdns
  namespace: dns-system
  labels:
    app: powerdns
spec:
  replicas: 1 # DNS should be singular for consistency
  selector:
    matchLabels:
      app: powerdns
  template:
    metadata:
      labels:
        app: powerdns
    spec:
      containers:
        - name: powerdns
          image: powerdns/pdns-auth-master:latest
          ports:
            - name: dns-udp
              containerPort: 53
              protocol: UDP
            - name: dns-tcp
              containerPort: 53
              protocol: TCP
            - name: api
              containerPort: 8081
              protocol: TCP
          env:
            - name: PDNS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: powerdns-api-key
                  key: powerdns_api_key
          volumeMounts:
            - name: config
              mountPath: /etc/powerdns
            - name: data
              mountPath: /var/lib/powerdns
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/v1/servers/localhost
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: powerdns-config
        - name: data
          persistentVolumeClaim:
            claimName: powerdns-data
