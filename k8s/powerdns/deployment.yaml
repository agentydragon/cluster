---
apiVersion: v1
kind: ConfigMap
metadata:
  name: powerdns-config
  namespace: dns-system
data:
  pdns.conf: |
    # PowerDNS configuration for cluster DNS
    launch=gsqlite3
    gsqlite3-database=/var/lib/powerdns/pdns.db

    # API configuration for cert-manager integration
    api=yes
    api-key=changeme-secure-api-key
    webserver=yes
    webserver-address=0.0.0.0
    webserver-port=8081
    webserver-allow-from=0.0.0.0/0

    # Security settings
    security-poll-suffix=
    disable-syslog=yes
    log-dns-details=yes
    loglevel=4

    # Disable control socket - not needed for API-only access
    socket-dir=

    # Performance settings
    cache-ttl=60
    negquery-cache-ttl=60
    query-cache-ttl=60

    # Zone transfer settings
    primary=yes
    secondary=no
---
# TODO: Replace with ExternalSecret that syncs from Vault when migrating PowerDNS API key
# Secret is generated by powerdns-secrets Terraform resource
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: powerdns
  namespace: dns-system
  labels:
    app: powerdns
spec:
  replicas: 1 # DNS should be singular for consistency
  selector:
    matchLabels:
      app: powerdns
  template:
    metadata:
      labels:
        app: powerdns
    spec:
      # Initialize SQLite database if it doesn't exist
      initContainers:
        - name: init-db
          image: keinos/sqlite3:latest
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: false
            runAsUser: 0
            runAsGroup: 0
            seccompProfile:
              type: RuntimeDefault
          command:
            - sh
            - -c
            - |
              # Create database directory
              mkdir -p /var/lib/powerdns

              # Clean up any stale control socket
              rm -f /var/lib/powerdns/pdns.controlsocket

              # Only initialize if database doesn't exist
              if [ ! -f /var/lib/powerdns/pdns.db ]; then
                echo "Initializing PowerDNS SQLite database..."

                # Initialize the database with schema
                sqlite3 /var/lib/powerdns/pdns.db < /etc/powerdns-schema/schema.sql

                # Set proper permissions for database file and directory
                chmod 666 /var/lib/powerdns/pdns.db
                chmod 777 /var/lib/powerdns
                echo "PowerDNS database initialized successfully"
              else
                echo "PowerDNS database already exists, skipping initialization"
                # Still ensure permissions are correct
                chmod 666 /var/lib/powerdns/pdns.db
                chmod 777 /var/lib/powerdns
              fi
          volumeMounts:
            - name: data
              mountPath: /var/lib/powerdns
            - name: schema
              mountPath: /etc/powerdns-schema
      containers:
        - name: powerdns
          image: powerdns/pdns-auth-master:latest
          command: ["pdns_server", "--config-dir=/etc/powerdns"]
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 953
            runAsGroup: 953
            seccompProfile:
              type: RuntimeDefault
          ports:
            - name: dns-udp
              containerPort: 53
              protocol: UDP
            - name: dns-tcp
              containerPort: 53
              protocol: TCP
            - name: api
              containerPort: 8081
              protocol: TCP
          env:
            - name: PDNS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: powerdns-api-key
                  key: powerdns_api_key
          volumeMounts:
            - name: config
              mountPath: /etc/powerdns
            - name: data
              mountPath: /var/lib/powerdns
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: powerdns-config
        - name: schema
          configMap:
            name: powerdns-schema
        - name: data
          persistentVolumeClaim:
            claimName: powerdns-data
