---
apiVersion: v1
kind: Namespace
metadata:
  name: authentik
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 24h
  url: https://charts.goauthentik.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 15m
  chart:
    spec:
      chart: authentik
      version: "2025.10.1"
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: authentik
  values:
    # Global configuration
    global:
      deploymentAnnotations:
        secret.reloader.stakater.com/reload: "authentik-secrets"

    # Authentik server configuration
    authentik:
      # Secret key for encryption (will be generated)
      secret_key: "please-change-me-in-production-to-32-byte-key"

      # Error reporting
      error_reporting:
        enabled: false

      # PostgreSQL configuration (using built-in PostgreSQL)
      # postgresql config will be auto-generated by chart

      # Redis configuration (optional for better performance)
      redis:
        host: ""

      # Bootstrap configuration (token from SealedSecret)
      bootstrap:
        password: "admin"
        # Token will be injected via extraEnvFrom
        token: ""

      # Extract bootstrap token from sealed secret and PostgreSQL password from external secret
      extraEnvFrom:
        - secretRef:
            name: bootstrap
        - secretRef:
            name: authentik-postgres-env

    # Server deployment
    server:
      name: server
      replicas: 1

      # Service configuration
      service:
        enabled: true
        type: NodePort
        port: 80
        nodePort: 30300

      # Ingress disabled (using NodePort)
      ingress:
        enabled: false

      # Resources
      resources:
        server:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi

    # Worker deployment
    worker:
      name: worker
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi

    # PostgreSQL with password injected via environment variable
    postgresql:
      enabled: true
      auth:
        existingSecret: "authentik-postgres-env"
        secretKeys:
          adminPasswordKey: "password"
          userPasswordKey: "password"

    # Redis (optional)
    redis:
      enabled: false

    # Service account
    serviceAccount:
      create: true
      name: authentik
