# Use shell.nix to get latest kubeseal, tflint, popeye, and other tools
use nix

# Set talos config path
export TALOSCONFIG="$PWD/terraform/01-infrastructure/talosconfig.yml"

# Set kubeconfig path (generated by terraform)
export KUBECONFIG="$PWD/terraform/01-infrastructure/kubeconfig"

# kubeseal configured to use standard defaults (kube-system namespace)

# Cluster banner
cat <<'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ðŸš€ Talos Kubernetes Cluster Environment                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cluster: test-cluster.agentydragon.com
Authentik: auth.test-cluster.agentydragon.com:8443

Helper commands:
  get-my-password     - Retrieve Authentik password for agentydragon@gmail.com

EOF

# Helper function to retrieve Authentik password
get-my-password() {
  kubectl get secret -n vault instance-unseal-keys -o jsonpath='{.data.vault-root}' | base64 -d > /tmp/vault-token
  kubectl port-forward -n vault svc/instance 8200:8200 > /dev/null 2>&1 &
  local PF_PID=$!
  sleep 2

  local PASSWORD=$(curl -s -H "X-Vault-Token: $(cat /tmp/vault-token)" \
    http://127.0.0.1:8200/v1/kv/data/authentik/admin | \
    jq -r '.data.data.password')

  kill $PF_PID 2>/dev/null
  rm /tmp/vault-token

  if [ -n "$PASSWORD" ] && [ "$PASSWORD" != "null" ]; then
    echo "Password for agentydragon@gmail.com: $PASSWORD"
  else
    echo "Error: Could not retrieve password from Vault"
    return 1
  fi
}
